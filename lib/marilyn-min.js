(function(e){if(typeof define==="function"&&define.amd){define(["underscore"],e)}else{window.Marilyn=window.marilyn=e(_)}})(function(e){var t;var n={};var r=[];var i={};var s=function(e){return i[e]};var o=function(s,o){var u=function(t){t=t&&e.isFunction(t)?t:function(){};var n;var r=function(e,r){a.inform(n,r);a.inform("save",r);a._retainContext=t;a._retainContext(e,r)};var i=function(e,t){if(a._afters.hasOwnProperty("save")){a._retainContext=a._afters.save;a._retainContext(t,function(){r(e,t)})}else{r(e,t)}};var s=function(e){a.updateSilent({__id:e.__id},e,function(e,t){var n=t[0];if(a._afters.hasOwnProperty("update")){a._retainContext=a._afters.update;a._retainContext(n,function(){i(e,n)})}else{i(e,n)}})};var o=function(e){a.createSilent(e,function(t,n){if(a._afters.hasOwnProperty("create")){a._retainContext=a._afters.create;a._retainContext(e,function(){i(t,n)})}else{i(t,n)}})};var u=function(e){if(!e.hasOwnProperty("__id")){n="create";if(a._befores.hasOwnProperty("create")){a._retainContext=a._befores.create;a._retainContext(e,function(){o(e)})}else{o(e)}}else{n="update";if(a._befores.hasOwnProperty("update")){a._retainContext=a._befores.update;a._retainContext({__id:e.__id},e,function(){s(e)})}else{s(e)}}};var f=this||{};if(a._befores.hasOwnProperty("save")){a._retainContext=a._befores.save;a._retainContext(f,function(){u(f)})}else{u(f)}};var a=i[s]=function(e){e=e||{};e.save=u;return e};a._collection=[];a._id=0;a._befores={};a._afters={};a._receivers={};a._name=s;a._retainContext=function(){};a._nextId=function(){a._id++;return a._id};a.on=function(e,r){if(!t){if(!n.hasOwnProperty(a._name)){n[a._name]={}}n[a._name][e]=r}else{t.on(e,function(e){a._retainContext=r;a._retainContext(e)})}};a.emit=function(e,n,i){if(!t){r.push([e,n,i])}else{t.emit(e,n,i)}};a.use=function(e){a._retainContext=e;a._retainContext()};a.before=function(e,t){a._befores[e]=t};a.beforeRemove=function(e){a._befores[e]=function(){}};a.after=function(e,t){a._afters[e]=t};a.afterRemove=function(e){a._afters[e]=function(){}};a.inform=function(e,t){if(a._receivers[e]){a._retainContext=a._receivers[e];a._retainContext(t)}};a.receive=function(e,t){a._receivers[e]=t};a.receiveRemove=function(t){if(e.isEmpty(t)){a._receivers={}}else{a._receivers[t]=function(){}}};a.collection=function(t){if(!e.isArray(t)){return}while(a._collection.length>0){a._collection.pop()}for(var n=0,r=t.length;n<r;n++){t[n].__id=a._nextId();a._collection.push(t[n])}};a.create=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){a.inform("create",t);a._retainContext=n;a._retainContext(e,t)};var i=function(){a.createSilent(t,function(e,n){n.save=u;if(a._afters.hasOwnProperty("create")){a._retainContext=a._afters.create;a._retainContext(t,function(){r(e,n)})}else{r(e,n)}})};if(a._befores.hasOwnProperty("create")){a._retainContext=a._befores.create;a._retainContext(t,function(){i()})}else{i()}};a.createSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;t.__id=a._nextId();a._collection.push(t);a._retainContext=n;a._retainContext(r,t)};a.read=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){a.inform("read",t);a._retainContext=n;a._retainContext(e,t)};var i=function(){a.readSilent(t,function(e,t){if(a._afters.hasOwnProperty("read")){a._retainContext=a._afters.read;a._retainContext(t,function(){r(e,t)})}else{r(e,t)}})};if(a._befores.hasOwnProperty("read")){a._retainContext=a._befores.read;a._retainContext(t,function(){i()})}else{i()}};a.readSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;var i=false;if(typeof t==="function"){n=t;i=true}else if(e.isEmpty(t)){i=true}var s=[];if(i){s=a._collection}else{s=e.where(a._collection,t)}if(s.length===0){r="item not found"}e.each(s,function(e){e.save=u});a._retainContext=n;a._retainContext(r,s)};a.readOne=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){a.inform("readOne",t);a._retainContext=n;a._retainContext(e,t)};var i=function(){a.readOneSilent(t,function(e,t){if(a._afters.hasOwnProperty("readOne")){a._retainContext=a._afters.readOne;a._retainContext(t,function(){r(e,t)})}else{r(e,t)}})};if(a._befores.hasOwnProperty("readOne")){a._retainContext=a._befores.readOne;a._retainContext(t,function(){i()})}else{i()}};a.readOneSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;var i=e.where(a._collection,t);var s=null;if(i[0]){s=i[0];s.save=u}else{r="item not found"}a._retainContext=n;a._retainContext(r,s)};a.update=function(t,n,r){r=r&&e.isFunction(r)?r:function(){};var i=function(e,t){a.inform("update",t);a._retainContext=r;a._retainContext(e,t)};var s=function(){a.updateSilent(t,n,function(e,t){if(a._afters.hasOwnProperty("update")){a._retainContext=a._afters.update;a._retainContext(t,function(){i(e,t)})}else{i(e,t)}})};if(a._befores.hasOwnProperty("update")){a._retainContext=a._befores.update;a._retainContext(t,n,function(){s()})}else{s()}};a.updateSilent=function(t,n,r){r=r&&e.isFunction(r)?r:function(){};var i=null;var s=e.where(a._collection,t);if(s.length>0){e.each(s,function(t){e.each(n,function(e,n){t[n]=e})})}else{i="item not found"}a._retainContext=r;a._retainContext(i,s)};a.del=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){a.inform("delete",t);a._retainContext=n;a._retainContext(e,t)};var i=function(){a.deleteSilent(t,function(e,t){if(a._afters.hasOwnProperty("delete")){a._retainContext=a._afters["delete"];a._retainContext(t,function(){r(e,t)})}else{r(e,t)}})};if(a._befores.hasOwnProperty("delete")){a._retainContext=a._befores["delete"];a._retainContext(t,function(){i()})}else{i()}};a.delSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;var i=e.where(a._collection,t);if(i.length>0){e.each(i,function(t){var n=e.indexOf(a._collection,t);a._collection.splice(n,1)})}else{r="item not found"}a._retainContext=n;a._retainContext(r,i)};a.find=a.read;a.findSilent=a.readSilent;a.findOne=a.readOne;a.findOneSilent=a.readOneSilent;a["delete"]=a.del;a.deleteSilent=a.delSilent;if(o){a.init=o;a.init();delete a.init}return a};var u={};u.VERSION="0.14.1";u.config=function(e){t=e;for(var s in n){for(var o in n[s]){(function(e,n,r){t.on(n,function(t){e._retainContext=r;e._retainContext(t)})})(i[s],o,n[s][o])}}for(var u=0,a=r.length;u<a;u++){t.emit(r[u][0],r[u][1],r[u][2])}n={}};u.model=function(e,t){if(i[e]&&!t){return s(e)}else{return o(e,t)}};u.modelRemove=function(e){i[e]=null};u.receiveRemove=function(e){for(var t in i){i[t].receiveRemove()}};return u})