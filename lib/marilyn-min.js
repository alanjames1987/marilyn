(function(e){if(typeof define==="function"&&define.amd){define(["underscore"],e)}if(typeof window==="object"&&typeof window.document==="object"){window.Marilyn=window.marilyn=e(_)}})(function(e){var t;var n={};var r={};var i=function(e){return r[e]};var s=function(i,s){var o=function(t){t=t&&e.isFunction(t)?t:function(){};var n=function(e,n){u.inform("save",n);u._retainScope=t;u._retainScope(e,n)};var r=function(e,t){if(u._afters.hasOwnProperty("save")){u._retainScope=u._afters.save;u._retainScope(t,function(){n(e,t)})}else{n(e,t)}};var i=function(e){u.updateSilent({__id:e.__id},e,function(e,t){var n=t[0];if(u._afters.hasOwnProperty("update")){u._retainScope=u._afters.update;u._retainScope(n,function(){r(e,n)})}else{r(e,n)}})};var s=function(e){u.createSilent(e,function(t,n){if(u._afters.hasOwnProperty("create")){u._retainScope=u._afters.create;u._retainScope(e,function(){r(t,n)})}else{r(t,n)}})};var o=function(e){if(!e.hasOwnProperty("__id")){if(u._befores.hasOwnProperty("create")){u._retainScope=u._befores.create;u._retainScope(e,function(){s(e)})}else{s(e)}}else{if(u._befores.hasOwnProperty("update")){u._retainScope=u._befores.update;u._retainScope({__id:e.__id},e,function(){i(e)})}else{i(e)}}};var a=this||{};if(u._befores.hasOwnProperty("save")){u._retainScope=u._befores.save;u._retainScope(a,function(){o(a)})}else{o(a)}};var u=r[i]=function(e){e=e||{};e.save=o;return e};u._collection=[];u._id=0;u._befores={};u._afters={};u._receivers={};u._name=i;u._retainScope=function(){};u._nextId=function(){u._id++;return u._id};u.on=function(e,r){if(!t){if(!n.hasOwnProperty(u._name)){n[u._name]={}}n[u._name][e]=r}else{t.on(e,function(e){u._retainScope=r;u._retainScope(e)})}};u.emit=function(e,n){if(t){t.emit(e,n)}};u.before=function(e,t){u._befores[e]=t};u.beforeRemove=function(e){u._befores[e]=function(){}};u.after=function(e,t){u._afters[e]=t};u.afterRemove=function(e){u._afters[e]=function(){}};u.inform=function(e,t){if(u._receivers[e]){u._retainScope=u._receivers[e];u._retainScope(t)}};u.receive=function(e,t){u._receivers[e]=t};u.receiveRemove=function(t){if(e.isEmpty(t)){u._receivers={}}else{u._receivers[t]=function(){}}};u.collection=function(t){if(!e.isArray(t)){return}for(var n=0,r=t.length;n<r;n++){t[n].__id=u._nextId()}u._collection=t};u.create=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){u.inform("create",t);u._retainScope=n;u._retainScope(e,t)};var i=function(){u.createSilent(t,function(e,n){if(u._afters.hasOwnProperty("create")){u._retainScope=u._afters.create;u._retainScope(t,function(){r(e,n)})}else{r(e,n)}})};if(u._befores.hasOwnProperty("create")){u._retainScope=u._befores.create;u._retainScope(t,function(){i()})}else{i()}};u.createSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;t.__id=u._nextId();u._collection.push(t);u._retainScope=n;u._retainScope(r,t)};u.read=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){u.inform("read",t);u._retainScope=n;u._retainScope(e,t)};var i=function(){u.readSilent(t,function(e,t){if(u._afters.hasOwnProperty("read")){u._retainScope=u._afters.read;u._retainScope(t,function(){r(e,t)})}else{r(e,t)}})};if(u._befores.hasOwnProperty("read")){u._retainScope=u._befores.read;u._retainScope(t,function(){i()})}else{i()}};u.readSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;var i=false;if(typeof t==="function"){n=t;i=true}else if(e.isEmpty(t)){i=true}var s=[];if(i){s=u._collection}else{s=e.where(u._collection,t)}if(s.length===0){r="item not found"}e.each(s,function(e){e.save=o});u._retainScope=n;u._retainScope(r,s)};u.readOne=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){u.inform("readOne",t);u._retainScope=n;u._retainScope(e,t)};var i=function(){u.readOneSilent(t,function(e,t){if(u._afters.hasOwnProperty("readOne")){u._retainScope=u._afters.readOne;u._retainScope(t,function(){r(e,t)})}else{r(e,t)}})};if(u._befores.hasOwnProperty("readOne")){u._retainScope=u._befores.readOne;u._retainScope(t,function(){i()})}else{i()}};u.readOneSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;var i=e.where(u._collection,t);var s=null;if(i[0]){s=i[0];s.save=o}else{r="item not found"}u._retainScope=n;u._retainScope(r,s)};u.update=function(t,n,r){r=r&&e.isFunction(r)?r:function(){};var i=function(e,t){u.inform("update",t);u._retainScope=r;u._retainScope(e,t)};var s=function(){u.updateSilent(t,n,function(e,t){if(u._afters.hasOwnProperty("update")){u._retainScope=u._afters.update;u._retainScope(t,function(){i(e,t)})}else{i(e,t)}})};if(u._befores.hasOwnProperty("update")){u._retainScope=u._befores.update;u._retainScope(t,n,function(){s()})}else{s()}};u.updateSilent=function(t,n,r){r=r&&e.isFunction(r)?r:function(){};var i=null;var s=e.where(u._collection,t);if(s.length>0){e.each(s,function(t){e.each(n,function(e,n){t[n]=e})})}else{i="item not found"}u._retainScope=r;u._retainScope(i,s)};u.del=u["delete"]=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){u.inform("delete",t);u._retainScope=n;u._retainScope(e,t)};var i=function(){u.deleteSilent(t,function(e,t){if(u._afters.hasOwnProperty("delete")){u._retainScope=u._afters["delete"];u._retainScope(t,function(){r(e,t)})}else{r(e,t)}})};if(u._befores.hasOwnProperty("delete")){u._retainScope=u._befores["delete"];u._retainScope(t,function(){i()})}else{i()}};u.delSilent=u.deleteSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;var i=e.where(u._collection,t);if(i.length>0){e.each(i,function(t){var n=e.indexOf(u._collection,t);u._collection.splice(n,1)})}else{r="item not found"}u._retainScope=n;u._retainScope(r,i)};if(s){u.init=s;u.init();delete u.init}return u};var o={};o.VERSION="0.11.0";o.config=function(e){t=e;for(var i in n){for(var s in n[i]){(function(e,n,r){t.on(n,function(t){e._retainScope=r;e._retainScope(t)})})(r[i],s,n[i][s])}}n={}};o.model=function(e,t){if(r[e]){return i(e)}else{return s(e,t)}};o.modelRemove=function(e){r[e]=null};o.receiveRemove=function(e){for(var t in r){r[t].receiveRemove()}};return o})