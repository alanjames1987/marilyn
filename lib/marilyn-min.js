!function(e){"function"==typeof define&&define.amd?define(["underscore"],e):window.Marilyn=window.marilyn=e(_)}(function(e){var n,t={},i=[],o={},r=function(e){return o[e]},c=function(r,c){var a=function(n){n=n&&e.isFunction(n)?n:function(){};var t,i=function(e,i){"create"===t?u.inform("create",i):"update"===t&&u.inform("update",[i]),u.inform("save",i),n.call(u,e,i)},o=function(e,n){u._afters.hasOwnProperty("save")?u._afters.save.call(u,n,function(){i(e,n)}):i(e,n)},r=function(e){u.updateSilent({__id:e.__id},e,function(e,n){var t=n[0];u._afters.hasOwnProperty("update")?u._afters.update.call(u,n,function(){o(e,t)}):o(e,t)})},c=function(e){u.createSilent(e,function(n,t){u._afters.hasOwnProperty("create")?u._afters.create.call(u,e,function(){o(n,t)}):o(n,t)})},a=function(e){e.hasOwnProperty("__id")?(t="update",u._befores.hasOwnProperty("update")?u._befores.update.call(u,{__id:e.__id},e,function(){r(e)}):r(e)):(t="create",u._befores.hasOwnProperty("create")?u._befores.create.call(u,e,function(){c(e)}):c(e))},l=this||{};u._befores.hasOwnProperty("save")?u._befores.save.call(u,l,function(){a(l)}):a(l)},l=function(n){n=n&&e.isFunction(n)?n:function(){},u.del(this,n)},f=function(n){n=n&&e.isFunction(n)?n:function(){},u.delSilent(this,n)},u=o[r]=function(e){return e=e||{},e.save=a,e};return u._collection=[],u._id=0,u._befores={},u._afters={},u._receivers={},u._name=r,u._nextId=function(){return u._id++,u._id},u.on=function(e,i){n?n.on(e,function(e){i.call(u,e)}):(t.hasOwnProperty(u._name)||(t[u._name]={}),t[u._name][e]=i)},u.emit=function(e,t,o){n?n.emit(e,t,o):i.push([e,t,o])},u.use=function(e){e.call(u)},u.before=function(n,t){e.isString(n)?u._befores[n]=t:e.isArray(n)&&e.each(n,function(e){u._befores[e]=t})},u.beforeRemove=function(n){e.isString(n)?u._befores[n]=function(){}:e.isArray(n)&&e.each(n,function(e){u._befores[e]=function(){}})},u.after=function(n,t){e.isString(n)?u._afters[n]=t:e.isArray(n)&&e.each(n,function(e){u._afters[e]=t})},u.afterRemove=function(n){e.isString(n)?u._afters[n]=function(){}:e.isArray(n)&&e.each(n,function(e){u._afters[e]=function(){}})},u.inform=function(e,n){u._receivers[e]&&u._receivers[e].call(u,n)},u.receive=function(n,t){e.isString(n)?u._receivers[n]=t:e.isArray(n)&&e.each(n,function(e){u._receivers[e]=t})},u.receiveRemove=function(n){e.isEmpty(n)?u._receivers={}:e.isString(n)?u._receivers[n]=function(){}:e.isArray(n)&&e.each(n,function(e){u._receivers[e]=function(){}})},u.collection=function(n){if(e.isArray(n)){for(;u._collection.length>0;)u._collection.pop();for(var t=0,i=n.length;i>t;t++)n[t].__id=u._nextId(),u._collection.push(n[t])}},u.create=function(n,t){var i=e.clone(n);t=t&&e.isFunction(t)?t:function(){};var o=function(e,n){u.inform("create",n),t.call(u,e,n)},r=function(){u.createSilent(n,function(e,n){return u._afters.hasOwnProperty("create")?3==u._afters.create.length?void u._afters.create.call(u,i,n,function(){o(e,n)}):void u._afters.create.call(u,n,function(){o(e,n)}):void o(e,n)})};return u._befores.hasOwnProperty("create")?void u._befores.create.call(u,n,function(){r()}):void r()},u.createSilent=function(n,t){t=t&&e.isFunction(t)?t:function(){};var i=null;n.__id=u._nextId(),n.save=a,n.del=function(e){l.call(n,e)},n.delSilent=function(e){f.call(n,e)},n["delete"]=n.del,n.deleteSilent=n.delSilent,u._collection.push(n),t.call(u,i,n)},u.read=function(n,t){var i=e.clone(n);t=t&&e.isFunction(t)?t:function(){};var o=function(e,n){u.inform("read",n),t.call(u,e,n)},r=function(){u.readSilent(n,function(e,n){return u._afters.hasOwnProperty("read")?3==u._afters.read.length?void u._afters.read.call(u,i,n,function(){o(e,n)}):void u._afters.read.call(u,n,function(){o(e,n)}):void o(e,n)})};return u._befores.hasOwnProperty("read")?void u._befores.read.call(u,n,function(){r()}):void r()},u.readSilent=function(n,t){t=t&&e.isFunction(t)?t:function(){};var i=null,o=!1;"function"==typeof n?(t=n,o=!0):e.isEmpty(n)&&(o=!0);var r=[];r=o?u._collection:e.where(u._collection,n),e.each(r,function(e){e.save=a,e.del=function(n){l.call(e,n)},e.delSilent=function(n){f.call(e,n)},e["delete"]=e.del,e.deleteSilent=e.delSilent}),t.call(u,i,r)},u.readOne=function(n,t){var i=e.clone(n);t=t&&e.isFunction(t)?t:function(){};var o=function(e,n){u.inform("readOne",n),t.call(u,e,n)},r=function(){u.readOneSilent(n,function(e,n){return u._afters.hasOwnProperty("readOne")?3==u._afters.readOne.length?void u._afters.readOne.call(u,i,n,function(){o(e,n)}):void u._afters.readOne.call(u,n,function(){o(e,n)}):void o(e,n)})};u._befores.hasOwnProperty("readOne")?u._befores.readOne.call(u,n,function(){r()}):r()},u.readOneSilent=function(n,t){t=t&&e.isFunction(t)?t:function(){};var i=null,o=e.where(u._collection,n),r=null;o[0]&&(r=o[0],r.save=a,r.del=function(e){l.call(r,e)},r.delSilent=function(e){f.call(r,e)},r["delete"]=r.del,r.deleteSilent=r.delSilent),t.call(u,i,r)},u.update=function(n,t,i){var o=e.clone(n),r=e.clone(t);i=i&&e.isFunction(i)?i:function(){};var c=function(e,n){u.inform("update",n),i.call(u,e,n)},a=function(){u.updateSilent(n,t,function(e,n){return u._afters.hasOwnProperty("update")?4==u._afters.update.length?void u._afters.update.call(u,o,r,n,function(){c(e,n)}):void u._afters.update.call(u,n,function(){c(e,n)}):void c(e,n)})};return u._befores.hasOwnProperty("update")?void u._befores.update.call(u,n,t,function(){a()}):void a()},u.updateSilent=function(n,t,i){i=i&&e.isFunction(i)?i:function(){};var o=null,r=e.where(u._collection,n);r.length>0&&e.each(r,function(n){e.each(t,function(e,t){n[t]=e})}),i.call(u,o,r)},u.del=function(n,t){var i=e.clone(n);t=t&&e.isFunction(t)?t:function(){};var o=function(e,n){u.inform("delete",n),t.call(u,e,n)},r=function(){u.deleteSilent(n,function(e,n){return u._afters.hasOwnProperty("delete")?3==u._afters["delete"].length?void u._afters["delete"].call(u,i,n,function(){o(e,n)}):void u._afters["delete"].call(u,n,function(){o(e,n)}):void o(e,n)})};return u._befores.hasOwnProperty("delete")?void u._befores["delete"].call(u,n,function(){r()}):void r()},u.delSilent=function(n,t){t=t&&e.isFunction(t)?t:function(){};var i=null,o=e.where(u._collection,n);o.length>0&&e.each(o,function(n){var t=e.indexOf(u._collection,n);u._collection.splice(t,1)}),t.call(u,i,o)},u.find=u.read,u.findSilent=u.readSilent,u.findOne=u.readOne,u.findOneSilent=u.readOneSilent,u["delete"]=u.del,u.deleteSilent=u.delSilent,c=c&&e.isFunction(c)?c:function(){},c.call(u),u},a={};return a.VERSION="0.17.1",a.config=function(e){n=e;for(var r in t)for(var c in t[r])!function(e,t,i){n.on(t,function(n){i.call(e,n)})}(o[r],c,t[r][c]);for(var a=0,l=i.length;l>a;a++)n.emit(i[a][0],i[a][1],i[a][2]);t={}},a.model=function(e,n){return o[e]&&!n?r(e):c(e,n)},a.modelRemove=function(e){o[e]=null},a.receiveRemove=function(){for(var e in o)o[e].receiveRemove()},a});