(function(e){if(typeof define==="function"&&define.amd){define(["underscore"],e)}else{window.Marilyn=window.marilyn=e(_)}})(function(e){var t;var n={};var r=[];var i={};var s=function(e){return i[e]};var o=function(s,o){var u=function(t){t=t&&e.isFunction(t)?t:function(){};var n;var r=function(e,r){l.inform(n,r);l.inform("save",r);l._retainContext=t;l._retainContext(e,r)};var i=function(e,t){if(l._afters.hasOwnProperty("save")){l._retainContext=l._afters.save;l._retainContext(t,function(){r(e,t)})}else{r(e,t)}};var s=function(e){l.updateSilent({__id:e.__id},e,function(e,t){var n=t[0];if(l._afters.hasOwnProperty("update")){l._retainContext=l._afters.update;l._retainContext(t,function(){i(e,n)})}else{i(e,n)}})};var o=function(e){l.createSilent(e,function(t,n){if(l._afters.hasOwnProperty("create")){l._retainContext=l._afters.create;l._retainContext(e,function(){i(t,n)})}else{i(t,n)}})};var u=function(e){if(!e.hasOwnProperty("__id")){n="create";if(l._befores.hasOwnProperty("create")){l._retainContext=l._befores.create;l._retainContext(e,function(){o(e)})}else{o(e)}}else{n="update";if(l._befores.hasOwnProperty("update")){l._retainContext=l._befores.update;l._retainContext({__id:e.__id},e,function(){s(e)})}else{s(e)}}};var a=this||{};if(l._befores.hasOwnProperty("save")){l._retainContext=l._befores.save;l._retainContext(a,function(){u(a)})}else{u(a)}};var a=function(t){t=t&&e.isFunction(t)?t:function(){};l.del(this,t)};var f=function(t){t=t&&e.isFunction(t)?t:function(){};l.delSilent(this,t)};var l=i[s]=function(e){e=e||{};e.save=u;return e};l._collection=[];l._id=0;l._befores={};l._afters={};l._receivers={};l._name=s;l._retainContext=function(){};l._nextId=function(){l._id++;return l._id};l.on=function(e,r){if(!t){if(!n.hasOwnProperty(l._name)){n[l._name]={}}n[l._name][e]=r}else{t.on(e,function(e){l._retainContext=r;l._retainContext(e)})}};l.emit=function(e,n,i){if(!t){r.push([e,n,i])}else{t.emit(e,n,i)}};l.use=function(e){l._retainContext=e;l._retainContext()};l.before=function(t,n){if(e.isString(t)){l._befores[t]=n}else if(e.isArray(t)){e.each(t,function(e){l._befores[e]=n})}};l.beforeRemove=function(t){if(e.isString(t)){l._befores[t]=function(){}}else if(e.isArray(t)){e.each(t,function(e){l._befores[e]=function(){}})}};l.after=function(t,n){if(e.isString(t)){l._afters[t]=n}else if(e.isArray(t)){e.each(t,function(e){l._afters[e]=n})}};l.afterRemove=function(t){if(e.isString(t)){l._afters[t]=function(){}}else if(e.isArray(t)){e.each(t,function(e){l._afters[e]=function(){}})}};l.inform=function(e,t){if(l._receivers[e]){l._retainContext=l._receivers[e];l._retainContext(t)}};l.receive=function(t,n){if(e.isString(t)){l._receivers[t]=n}else if(e.isArray(t)){e.each(t,function(e){l._receivers[e]=n})}};l.receiveRemove=function(t){if(e.isEmpty(t)){l._receivers={}}else{if(e.isString(t)){l._receivers[t]=function(){}}else if(e.isArray(t)){e.each(t,function(e){l._receivers[e]=function(){}})}}};l.collection=function(t){if(!e.isArray(t)){return}while(l._collection.length>0){l._collection.pop()}for(var n=0,r=t.length;n<r;n++){t[n].__id=l._nextId();l._collection.push(t[n])}};l.create=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){l.inform("create",t);l._retainContext=n;l._retainContext(e,t)};var i=function(){l.createSilent(t,function(e,n){if(l._afters.hasOwnProperty("create")){l._retainContext=l._afters.create;l._retainContext(t,function(){r(e,n)})}else{r(e,n)}})};if(l._befores.hasOwnProperty("create")){l._retainContext=l._befores.create;l._retainContext(t,function(){i()})}else{i()}};l.createSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;t.__id=l._nextId();t.save=u;t.del=function(e){a.call(t,e)};t.delSilent=function(e){f.call(t,e)};t["delete"]=t.del;t.deleteSilent=t.delSilent;l._collection.push(t);l._retainContext=n;l._retainContext(r,t)};l.read=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){l.inform("read",t);l._retainContext=n;l._retainContext(e,t)};var i=function(){l.readSilent(t,function(e,t){if(l._afters.hasOwnProperty("read")){l._retainContext=l._afters.read;l._retainContext(t,function(){r(e,t)})}else{r(e,t)}})};if(l._befores.hasOwnProperty("read")){l._retainContext=l._befores.read;l._retainContext(t,function(){i()})}else{i()}};l.readSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;var i=false;if(typeof t==="function"){n=t;i=true}else if(e.isEmpty(t)){i=true}var s=[];if(i){s=l._collection}else{s=e.where(l._collection,t)}if(s.length===0){r="item not found"}e.each(s,function(e){e.save=u;e.del=function(t){a.call(e,t)};e.delSilent=function(t){f.call(e,t)};e["delete"]=e.del;e.deleteSilent=e.delSilent});l._retainContext=n;l._retainContext(r,s)};l.readOne=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){l.inform("readOne",t);l._retainContext=n;l._retainContext(e,t)};var i=function(){l.readOneSilent(t,function(e,t){if(l._afters.hasOwnProperty("readOne")){l._retainContext=l._afters.readOne;l._retainContext(t,function(){r(e,t)})}else{r(e,t)}})};if(l._befores.hasOwnProperty("readOne")){l._retainContext=l._befores.readOne;l._retainContext(t,function(){i()})}else{i()}};l.readOneSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;var i=e.where(l._collection,t);var s=null;if(i[0]){s=i[0];s.save=u;s.del=function(e){a.call(s,e)};s.delSilent=function(e){f.call(s,e)};s["delete"]=s.del;s.deleteSilent=s.delSilent}else{r="item not found"}l._retainContext=n;l._retainContext(r,s)};l.update=function(t,n,r){r=r&&e.isFunction(r)?r:function(){};var i=function(e,t){l.inform("update",t);l._retainContext=r;l._retainContext(e,t)};var s=function(){l.updateSilent(t,n,function(e,t){if(l._afters.hasOwnProperty("update")){l._retainContext=l._afters.update;l._retainContext(t,function(){i(e,t)})}else{i(e,t)}})};if(l._befores.hasOwnProperty("update")){l._retainContext=l._befores.update;l._retainContext(t,n,function(){s()})}else{s()}};l.updateSilent=function(t,n,r){r=r&&e.isFunction(r)?r:function(){};var i=null;var s=e.where(l._collection,t);if(s.length>0){e.each(s,function(t){e.each(n,function(e,n){t[n]=e})})}else{i="item not found"}l._retainContext=r;l._retainContext(i,s)};l.del=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=function(e,t){l.inform("delete",t);l._retainContext=n;l._retainContext(e,t)};var i=function(){l.deleteSilent(t,function(e,t){if(l._afters.hasOwnProperty("delete")){l._retainContext=l._afters["delete"];l._retainContext(t,function(){r(e,t)})}else{r(e,t)}})};if(l._befores.hasOwnProperty("delete")){l._retainContext=l._befores["delete"];l._retainContext(t,function(){i()})}else{i()}};l.delSilent=function(t,n){n=n&&e.isFunction(n)?n:function(){};var r=null;var i=e.where(l._collection,t);if(i.length>0){e.each(i,function(t){var n=e.indexOf(l._collection,t);l._collection.splice(n,1)})}else{r="item not found"}l._retainContext=n;l._retainContext(r,i)};l.find=l.read;l.findSilent=l.readSilent;l.findOne=l.readOne;l.findOneSilent=l.readOneSilent;l["delete"]=l.del;l.deleteSilent=l.delSilent;if(o){l.init=o;l.init();delete l.init}return l};var u={};u.VERSION="0.16.1";u.config=function(e){t=e;for(var s in n){for(var o in n[s]){(function(e,n,r){t.on(n,function(t){e._retainContext=r;e._retainContext(t)})})(i[s],o,n[s][o])}}for(var u=0,a=r.length;u<a;u++){t.emit(r[u][0],r[u][1],r[u][2])}n={}};u.model=function(e,t){if(i[e]&&!t){return s(e)}else{return o(e,t)}};u.modelRemove=function(e){i[e]=null};u.receiveRemove=function(e){for(var t in i){i[t].receiveRemove()}};return u})