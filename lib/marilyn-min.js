(function(){var e;var t={};var n={};var r=function(e){return n[e]};var i=function(r,i){var s=function(e){var t=function(t,n){o.inform("save",n);if(e){o._retainScope=e;o._retainScope(t,n)}};var n=function(e,n){if(o._afters.hasOwnProperty("save")){o._retainScope=o._afters["save"];o._retainScope(n,function(){t(e,n)})}else{t(e,n)}};var r=function(e){o.updateSilent({__id:e.__id},e,function(e,t){var r=t[0];if(o._afters.hasOwnProperty("update")){o._retainScope=o._afters["update"];o._retainScope(r,function(){n(e,r)})}else{n(e,r)}})};var i=function(e){o.createSilent(e,function(t,r){if(o._afters.hasOwnProperty("create")){o._retainScope=o._afters["create"];o._retainScope(e,function(){n(t,r)})}else{n(t,r)}})};var s=function(e){if(!e.hasOwnProperty("__id")){if(o._befores.hasOwnProperty("create")){o._retainScope=o._befores["create"];o._retainScope(e,function(){i(e)})}else{i(e)}}else{if(o._befores.hasOwnProperty("update")){o._retainScope=o._befores["update"];o._retainScope({__id:e.__id},e,function(){r(e)})}else{r(e)}}};var u=this||{};if(o._befores.hasOwnProperty("save")){o._retainScope=o._befores["save"];o._retainScope(u,function(){s(u)})}else{s(u)}};var o=n[r]=function(e){e=e||{};e.save=s;return e};o._collection=[];o._id=0;o._befores={};o._afters={};o._receivers={};o.name=r;o._retainScope=function(){};o._nextId=function(){o._id++;return o._id};o.on=function(n,r){if(!e){if(!t.hasOwnProperty(o.name)){t[o.name]={}}t[o.name][n]=r}else{e.on(n,function(e){o._retainScope=r;o._retainScope(e)})}};o.emit=function(t,n){if(e){e.emit(t,n)}};o.before=function(e,t){o._befores[e]=t};o.beforeRemove=function(e){o._befores[e]=function(){}};o.after=function(e,t){o._afters[e]=t};o.afterRemove=function(e){o._afters[e]=function(){}};o.inform=function(e,t){if(o._receivers[e]){o._retainScope=o._receivers[e];o._retainScope(t)}};o.receive=function(e,t){o._receivers[e]=t};o.receiveRemove=function(e){if(_.isEmpty(e)){o._receivers={}}else{o._receivers[e]=function(){}}};o.collection=function(e){if(!_.isArray(e)){return}for(var t=0,n=e.length;t<n;t++){e[t].__id=o._nextId()}o._collection=e};o.create=function(e,t){var n=function(e,n){o.inform("create",n);if(t){o._retainScope=t;o._retainScope(e,n)}};var r=function(){o.createSilent(e,function(t,r){if(o._afters.hasOwnProperty("create")){o._retainScope=o._afters["create"];o._retainScope(e,function(){n(t,r)})}else{n(t,r)}})};if(o._befores.hasOwnProperty("create")){o._retainScope=o._befores["create"];o._retainScope(e,function(){r()})}else{r()}};o.createSilent=function(e,t){var n=null;e.__id=o._nextId();o._collection.push(e);if(t){o._retainScope=t;o._retainScope(n,e)}};o.read=function(e,t){var n=function(e,n){o.inform("read",n);if(t){o._retainScope=t;o._retainScope(e,n)}};var r=function(){o.readSilent(e,function(e,t){if(o._afters.hasOwnProperty("read")){o._retainScope=o._afters["read"];o._retainScope(t,function(){n(e,t)})}else{n(e,t)}})};if(o._befores.hasOwnProperty("read")){o._retainScope=o._befores["read"];o._retainScope(e,function(){r()})}else{r()}};o.readSilent=function(e,t){var n=null;var r=false;if(typeof e==="function"){t=e;r=true}else if(_.isEmpty(e)){r=true}var i=[];if(r){i=o._collection}else{i=_.where(o._collection,e)}if(i.length===0){n="item not found"}_.each(i,function(e){e.save=s});if(t){o._retainScope=t;o._retainScope(n,i)}};o.readOne=function(e,t){var n=function(e,n){o.inform("readOne",n);if(t){o._retainScope=t;o._retainScope(e,n)}};var r=function(){o.readOneSilent(e,function(e,t){if(o._afters.hasOwnProperty("readOne")){o._retainScope=o._afters["readOne"];o._retainScope(t,function(){n(e,t)})}else{n(e,t)}})};if(o._befores.hasOwnProperty("readOne")){o._retainScope=o._befores["readOne"];o._retainScope(e,function(){r()})}else{r()}};o.readOneSilent=function(e,t){var n=null;var r=_.where(o._collection,e);var i=null;if(r[0]){i=r[0];i.save=s}else{n="item not found"}if(t){o._retainScope=t;o._retainScope(n,i)}};o.update=function(e,t,n){var r=function(e,t){o.inform("update",t);if(n){o._retainScope=n;o._retainScope(e,t)}};var i=function(){o.updateSilent(e,t,function(e,t){if(o._afters.hasOwnProperty("update")){o._retainScope=o._afters["update"];o._retainScope(t,function(){r(e,t)})}else{r(e,t)}})};if(o._befores.hasOwnProperty("update")){o._retainScope=o._befores["update"];o._retainScope(e,t,function(){i()})}else{i()}};o.updateSilent=function(e,t,n){var r=null;var i=_.where(o._collection,e);if(i.length>0){_.each(i,function(e){_.each(t,function(t,n){e[n]=t})})}else{r="item not found"}if(n){o._retainScope=n;o._retainScope(r,i)}};o.del=o["delete"]=function(e,t){var n=function(e,n){o.inform("delete",n);if(t){o._retainScope=t;o._retainScope(e,n)}};var r=function(){o.deleteSilent(e,function(e,t){if(o._afters.hasOwnProperty("delete")){o._retainScope=o._afters["delete"];o._retainScope(t,function(){n(e,t)})}else{n(e,t)}})};if(o._befores.hasOwnProperty("delete")){o._retainScope=o._befores["delete"];o._retainScope(e,function(){r()})}else{r()}};o.delSilent=o.deleteSilent=function(e,t){var n=null;var r=_.where(o._collection,e);if(r.length>0){_.each(r,function(e){var t=_.indexOf(o._collection,e);o._collection.splice(t,1)})}else{n="item not found"}if(t){o._retainScope=t;o._retainScope(n,r)}};if(i){o.init=i;o.init();delete o.init}return o};var s={};s.VERSION="0.9.1";s.config=function(r){e=r;for(var i in t){for(var s in t[i]){(function(t,n,r){e.on(n,function(e){t._retainScope=r;t._retainScope(e)})})(n[i],s,t[i][s])}}};s.model=function(e,t){if(n[e]){return r(e)}else{return i(e,t)}};s.modelRemove=function(e){n[e]=null};s.receiveRemove=function(e){for(var t in n){n[t].receiveRemove()}};window.Marilyn=s})()